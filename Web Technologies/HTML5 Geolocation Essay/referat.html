<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">

    <link rel="stylesheet" href="resourses/referat.css">
    <script src="resourses/run_prettify.js"></script>
    </head>

    <nav class="floating-menu">
        <a href="#intro">Увод</a>
            <a href="#implementation">Имплеменация в браузърите</a>
            <a href="#api">API</a>
            <a href="#example1">Пример</a>
            <a href="#end">Заключение</a>
            <a href="#resourses">Използвани източници</a>
    </nav>
        <div class="document">

        <h1>HTML Geolocation API</h1>

        <h2 id="intro">Увод</h2>
        <p>HTML5 e най-новата стандартизация на маркиращия език (markup language) HTML. Последната промяна на предишната версия на езика е от 2000 година. С навлизането на нови технологии се налага създаването на нова версия на стандарта за добяването на нови функционалностти. Работата по HTML5 започва през 2004 година. Поради нуждите за равзвитие на езика се създава група от заинтересовани хора наречена Web Hypertext Application Technology Working Group. Групата е основана от хора от Аpple, Mozzila Foundation и Opera Software. Основната причина за създаване на тази група е решението на W3C да се съсредоточат върху XML-базираните технологии за сметка на HTML.  Докато WHATWG се занимава с разработката на нова стандартизация на HTML, W3C се занимава с разработката на стандарта XHTML 2.0. В последсвие W3C решава да се заеме с разработката на HTML5, като окончателната работа по XHTML 2.0 спира през 2009 година. През 2007 година WHATWG предлага на W3C да изпозва домоментно създадената версия на HTML5 като начална точка. В последствие на 28 октомври 2014 г. Официално излиза първата версия на стандартизацията HTML5 като в момента се разработва HTML 5.1
        Новата стандартизация добавя много нови синтактични функционалности. В този текст ще се съсредоточим върху една от тях – API за геолокация.</p>
    
        <h2 id="implementation">Имплеменация в браузърите</h2>
        <p>Основата на геолокацията в HTML5 е да се намери приблизително информация за географското местоположение на клиента. За целта се дефинират редица обекти, които при изпълнението им дава на приложението информация за местоположението на клиентското устройство, като за целта се консултира до сървъри за информация за местоположението(Location Information Servers). Най-често използваните методи за намиране на тази информация са IP адреса, MAC адреса, радио-честотната идентификация, местоположението на Wi-Fi връзката, вграденият GPS на устройството и идентификатора на GSM клетката. В зависимост от това кой източник е използван за намиране на геолокацията, тя може да бъде точна или приблизителна. В тази секция ще разгледаме, как различните браузъри имплементират намирането на геолокацията на клиента.</p>
        <h3>Google gears</h3>
        <p>Google Gears е свободен софтуер с отворен код, който добавя редица функционалности към браузърите, които ги няма в стандартизацията на HTML. Едно от тях е именно геолокацията. Първата версия на софтуера е от 31 май 2007 година, като API за геолокация е добавено във версия 0.4 от 22 август 2008г. В последствие Google се отказват от този проект, като решават да работят по добавянето на функционалностите на Gears в новият стандарт HTML5. Във последствие повечето браузъри спират поддръжката на софтуера, и вместо това преминават към новото API предоставено от HTML5. През следващите няколко години приложението все още предлага достъп до геолокация за по-старите версии браузъри, които не са имплементирали HTML5 Geolocation API. През 2012 година обаче сървърското API, което е нужно за установяване на локацията, спира да работи. Повечето браузъри обаче по това време вече са преминали към API-то предоставено от стандарта HTML5.</p>
        <h3>Internet Explorer</h3>
        <p>По-старите версии на Internet Explorer като IE7 и IE8 изпозват Google Gears Geolocation API за нуждите за намиране на местоположението на потребителя. Във версия 9.0 на браузъра, излязла на 14 март 2011 г., вече се използва HTML5 Geolocation API. Браузърът използва Microsoft Location Service за да намери локацията на потребителя. Начинът да бъде направено това е следният. Системата използва IP-то на потребителия, както и IP-тата на близките Wi-Fi точки. След като получи тази информация Microsoft Location Service сравнява тези IP адреси с базата си данни, като така намира приблизителната локация на клиента</p>
        <h3>Chrome</h3>
        <p>Google Chrome поддържа геолокация от създаването на браузъра. За целта браузъра изпраща заявка до  Google Location Services, за да намери местоположението на клиента. За целта се използват различни техники като проверяване на IP адреса в база данни, използване на GPS-а на устройството ако има такова, GPS клетките на мобилните устройства и редица други. Android устройствата редовно проверяват местоположението на устройството.</p>
        <h3>Firefox</h3>
        <p>Firefox поддържа геолокация от версия 3.5 излязла на 30 юни 2009 година. Подобно на Google Chrome браузърът изпраща заявка до  Google Location Services и получава координатите на потребителя. </p>
        <h3>Opera</h3>
        <p>Opera поддържа геолокация от версия 10.6 излязла през юли 2010 година. Подобна на Google Chrome и Mozzila Firefox браузърът изпраща заявка до  Google Location Services за да получите координатите на потребителя. За потребители на настрони компютри информацията която се изпраща е IP адреса на устройството. В тези случаи координатите са доста груби и не може да се получи добро приближение до локацията на потребителя. При лаптопи освен IP адреса се изпраща и информация от близките Wi-Fi точки като Mac адрес на устройството и сила на сигнала. Това ползволява по-добро прецизиране на местоположението на потребителя, но зависи много от наличието на достатъчен брой познати Wi-Fi точки. При мобилните устройства се изпраща идентификатора на най-близките клетки и силата на техния сигнал. Ако устройството има GSM чип, то той също се използва за намирането на локацията. </p>
        <h3>Safari</h3>
        <p>Safari поддължа геолокация от версия 5 излязла на 7 юни 2010 година. Първоначално Apple използват услугите на Google Location Services и на Skyhook за нуждите на своите устройства. През април 2010 година обаче, решават да използват собствена база данни за намирането на локацията на потребителя. Това се осъществява по подобен начин, чрез търсенето на IP адреса в база данни.</p>
        <h3>Сигурност</h3>
        <p>Един от основните въпроси, които повдига използването на геолокацията, е този за сигурността на данните. За целта при поискване на тази информация от страна на сайта, браузъра дава на потребителя да реши дали да даде информацията за своето местоположение на уебсайта или не. Също така потребителя има възможност да добави сайта към тези на които има доверие и да му даде достъп до информацията за геолокация при всяко поискване без да е нужно потребителя да ауторизира предаването всеки път. Браузърите са задължени да не предават информацията, ако потребителя не даде своето съгласие. Оттам нататък сигурността на данните зависи от политиката за сигурност на самият уебсайт. Освен това браузърите дават опцията да се изключи изцяло намирането на геолокацията на потребителя.</p>

        <h2 id="api">API</h2>
        <p>В следващата част ще разгледаме различните класове, интерфейси и функции които съставляват HTML5 Geolocation API и тяхното използване.</p>
        <h3>NavigatorGeolocation</h3>
        <pre class="prettyprint"><code>
[NoInterfaceObject]
interface NavigatorGeolocation {
    readonly attribute Geolocation geolocation;
};

Navigator implements NavigatorGeolocation;
        </code></pre>
        <p>Navigator е основният интерфейс, който се имплементира от различните обекти, като например window.navigator. Той от своя страна имплементира интерфейса NavigatorGeolocation. Този интерфейс съдържа един единствен атрибут, който не може да бъде променян от тип Geolocation. Geolocation съдържа основната логика за търсенето и запазването на позициятата. <p>


        <h3>Geolocation </h3>
        <pre class="prettyprint"><code>
[NoInterfaceObject]
interface Geolocation {
    void getCurrentPosition(PositionCallback successCallback,
                            optional PositionErrorCallback errorCallback,
                            optional PositionOptions options);

    long watchPosition(PositionCallback successCallback,
                      optional PositionErrorCallback errorCallback,
                      optional PositionOptions options);

   void clearWatch(long watchId);
 };

 callback PositionCallback = void (Position position);
 callback PositionErrorCallback = void (PositionError positionError);
        </code></pre>
        <p>Интерфейса Geolocation съдържа основната логика за това за намирането на геолокацият. Ще разгледаме трите му функции и как работят при извикването им.</p>
        <h4>getCurrentPosition()</h4>
        <p>getCurrentPosition() e функцията чрез която се запазва местоположението на потребителя. При извикване тя автоматична завършва и след това асихронно се опитва да намери местоположението на устройството. В случай че такова бъде намерено извиква PositionCallback, който създава нов обект от тип Position, който съдържа информацията за местоположението. Самият интерфейс Position ще разгледаме по-късно. В случай, че опита за разпознаване на местоположението е неуспешен, то се извиква PositionErrorCallback, който създава нов обект от тип Position Error, съдържащ информация защо е неуспешет опита.</p>
        <p>Сега ще разгледаме какво е поведението на функцията при извикването и.</p>
        <ol>
            <li>
                Първо проверява дали е подадеден параметъра options от тип PositionOption. Той може да съдържа три параметъра. Самата имплементация на интерфейса му може да бъде видяна по-надолу в документа.
                <ul>
                    <li>Ако атрибута maximumAge е дефиниран и съдържа неотрицателна стойност, то тази стойност се присвоява на вътрешната променлива maximumAge. В противен случай на вътрешната променлива maximumAge се присвоява стойност 0.</li>
                    <li>Ако атрибута timeout е дефиниран и съдържа неотрицателно стойност, то тя се присвоява на вътрешната променлива timeout. Ако timeout e дефиниран и съдържа отрицателна стойност, то на вътрешната променлива се присвоява стойност 0. Ако отрибута не е дефиниран, то на вътрешната променлива се присвоява безкрайност.</li>
                    <li>Ако атрибута enableHighAccuracy е дефиниран, то стойността му се присвоява на вътрешната променлива enableHighAccuracy. В противен случай на enableHighAccuracy се дава стойност false.</li>
                </ul>
            </li>
            <li>
                Ако вече има кеширан обект от тип Position, чиято възраст не е по-голяма от стойността на вътрешната променлива maximumAge, то алгоритъма приключва и се извиква successCallback използвайки този кеширан обект. Идеята е, ако не е изминало много време от предишното извикване на функцията, да не се налага наново да се търси информация за локацията на устройството.
            </li>
                
            <li>
                Ако вътрешната променлива timeout има стойност 0, то алгоритъма приключва и се извиква errorCallback с нов обект от тип PositionError, чиито атрибут code има стойност TIMEOUT.
            </li>
            <li>
                Функцията започва операцията по започване търсенето на местоположението. Начина на търсенето е различно в зависимост от устройството и браузъра. Както вече споменахме в предната глава, всеки браузър има свои методи за намиране на геолокацията на потребителя. Това търсене може да вземе впредвид стойността на вътрешната променлива enableHighAccuracy.
            </li>
            <li>
                При започване на търсенето на местоположението, се стартира таймер, който отброява колко милисекунди са изминали от началото на операцията. Когато таймера достигне стойността зададена във вътрешната променлива timeout, процеса бива спрян и функцията приключва работата си. Извиква се извиква errorCallback с нов обект от тип PositionError, чиито атрибут code има стойност TIMEOUT.
            </li>
            <li>
                Ако операцията завърши успешно преди да приключи времето, то таймерът се спира и се извиква successCallback с нов обект от тип Position съдържат намерената информация.
            </li>
            <li>
                Ако операцията завърши с грешка преди да изтече времето, то таймерът се спира и се извиква errorCallback с нов обект от тип PositionError, чиито атрибут code има стойност POSITION_UNAVAILABLE.
            </li>
        </ol>

        <h4>watchPosition()</h4>
        <p>Функцията watchPosition() се изполна за следене на местоположението на потребителя. При извикването и връща челочислена стойност от тип long, която е уникален идентификатор за тази операция за следене, която започва да работи асихронно. Първо операцията се опитва да установи текущото местоположение на потребителя. При успех извикна successCallback с нов обект от тип Position. В противен случай извиква errorCallback. Операцията продължава да следи за местоположението на потребителя и при неговата поменя извиква правилния callback. За да се спре операцията за следене на местоположението, трябва да се извика функцията clearWatch(), която ще разгледаме по-късно.</p>
        <p>Нека разгледаме как работи функцията по стъпки.</p>
        <ol>
            <li>
                Първо се изпълняват предварителните стъпки, които съвпадат с тези на функцията getCurrentPosition().<br>
                Първо проверява дали е подадеден параметъра options от тип PositionOption. Той може да съдържа три параметъра. Самата имплементация на интерфейса му може да бъде видяна по-надолу в документа.
                <ul>
                    <li>Ако атрибута maximumAge е дефиниран и съдържа неотрицателна стойност, то тази стойност се присвоява на вътрешната променлива maximumAge. В противен случай на вътрешната променлива maximumAge се присвоява стойност 0.</li>
                    <li>Ако атрибута timeout е дефиниран и съдържа неотрицателно стойност, то тя се присвоява на вътрешната променлива timeout. Ако timeout e дефиниран и съдържа отрицателна стойност, то на вътрешната променлива се присвоява стойност 0. Ако отрибута не е дефиниран, то на вътрешната променлива се присвоява безкрайност.</li>
                    <li>Ако атрибута enableHighAccuracy е дефиниран, то стойността му се присвоява на вътрешната променлива enableHighAccuracy. В противен случай на enableHighAccuracy се дава стойност false.</li>
                </ul>
            </li>
            <li>
                Ако вече има кеширан обект от тип Position, чиято възраст не е по-голяма от стойността на вътрешната променлива maximumAge, то алгоритъма приключва и се извиква successCallback използвайки този кеширан обект.
            </li>
            <li>
                Функцията започва да получава системните евенти, които подсказват, че се е променило местоположението на устройството. Това например може да се направи, като се следи за силата на сигнала от WiFi или GSM клетки.
            </li>
            <li>
                Започва процедурата за получаване на текущото местоположение, като евентуарно взима в предвид стойността на атрибута enableHighAccuracy.
            </li>
            <li>
                Изпълнява следните стъпки за получаване на местоположението.
                <ol>
                    <li>
                        Ако таймерътне е е вече включен, го пуска. Ако таймерът достигне до стойността зададена от вътрешната променлива timeout, то връща  errorCallback със нов обект от тип PositionError, чиито атрибут code има стойност TIMEOUT и отива директно на стъпка 6.
                    </li>
                    <li>
                        Ако получи информацията за местоположението преди да приключи таймера изпълнява следните две стъпки.
                    <ul>
                        <li>
                            Спира текущия таймер.
                        </li>
                        <li>
                            Ако местоположението се разминава значително от предишното местоположение, извиква successCallback с нов обект от тип Position, който съдържа новата локация.
                        </li>
                    </ul>
                    </li>
                    <li>
                        Ако не успее да получи ново местоположение, извиква errorCallback с нов обект от тип PositionError, чиито атрибут code има стойност POSITION_UNAVAILABLE.
                    </li>
                </ol>
                <li>
                    Изчаква да получи нов системен евент за промяна на местоположението. В този случай се връща обратно на стъпка 5.
                </li>
            </ol>
        И за двете функции имплементацията не позволява да се извика successCallback, ако потребителя не е авторизирал преди това уеб страницата да използва неговата локация. Ако потребетеля се съгласи, то функциите се изпълняват, както е описано по-горе. В противен случай се извиква errorCallback със стойност на променливата code PERMISSION_DENIED.
        <h4>clearWatch()</h4>
        <p>Функцията се извиква с един параметър от тип long. След това проверява дали стойността на този параметър не съвпада с идентификатора на някой стартиран процес watchPosition(). Ако намери такъв, то веднага го прекъсва. Ако не намери такъв, то приключва работата си без да предприема други действия.</p>


        <h3> PositionOptions </h3>
        <pre class="prettyprint"><code>[NoInterfaceObject]
interface PositionOptions {
    attribute boolean enableHighAccuracy;
    attribute long timeout;
    attribute long maximumAge;
};</code></pre>
        <p>Функциите getCurrentPosition() и watchPosition() използват обекти от тип PositionOptions като свой трети параметър. Самият обект от тип PositionOptions съдържа три атрибута, които дават някаква информация за това как да работят функциите за намиране на местоположението. Нека ги разледаме по подробно.</p>
        <ul>
            <li>
                enableHighAccuracy - атрибута казва на приложението дали иска да получи най-точната информация за местоположението на клиента. Ако тази опция бъде включена това може да доведе до по-бавно намиране на местоположението, тъй като трябва да бъдат направени множество проверки по различни признаци за да се направи геолокацията по-точна. Ако на функцията не бъде подаден този параметър стойността му по подразбиране е false. 
            </li>
            <li>
                timeout - атрибута казва на приложението, колко е максималното време в милисекунди, което може да мине от стартирането на функцията до извикването на successCallback. Целта е да се зададе някакво ограничение за това, колко време функцията може да прекара в търсене на местоположението на потребителя. Ако стойността на параметъра не е зададена, то приема стойност по подразбиране равна на безкрайност. Ако е зададена отрицателна стойност, приема стойност равна на 0. 
            </li>
            <li>
                maximumAge - атрибута, казва колко е максималната старост на предишно намерено местоположение, което все още може да бъде прието за вярно. Ако при извикване на функцията за намиране на текущото местоположение, има предишен намерено положение, което не е по старо от стойността зададена от maximumAge, то приема него и не търси ново.
            </li>
        </ul>

        <h3>Position </h3>
        <pre class="prettyprint"><code>[NoInterfaceObject]
interface Position {
    readonly attribute Coordinates coords;
    readonly attribute DOMTimeStamp timestamp;
};</code></pre>
        <p>Обекта от тип Position се връща при успешното намиране на местоположението, чрез successCallback. Той съдържа в себе си два атрибута.</p>
        <ul>
            <li>
                coords - Това е обект от тип Coordinates, където се съдържа всичката информация за намереното местоположение на потребителя. Самият интерфейс Coordinates ще разгледаме по-надолу.
            </li>
            <li>
                timeStamp - този атрибут съдържа точната дата и час, когато е намерена тази локация. Използва се заедно с maximumAge, за да провери дали тази локация е достатъчно стара за да потърси нова.
            </li>
        </ul>

        <h3>Coordinates </h3>
        <pre class="prettyprint"><code>[NoInterfaceObject]
interface Coordinates {
    readonly attribute double latitude;
    readonly attribute double longitude;
    readonly attribute double? altitude;
    readonly attribute double accuracy;
    readonly attribute double? altitudeAccuracy;
    readonly attribute double? heading;
    readonly attribute double? speed;
};</code></pre>
        <p>Интерфейса Coordinates съдържа всичката информация, за текущото местоположение на потребителя. Информацията е базирана на Световната геодезична система. Атрибутите, които съдържа този интерфейс са следните:</p>
        <ul>
            <li>
                latitude - географска ширина. Запазена е стойността в градуси.
            </li>
            <li>
                longitude - географска дължина. Запазена е стойността в градуси.
            </li>
            <li>
                altitude - надморска височина. Запазена е стойността в метри. Ако тази стойност не може да бъде намерена, то атрибута приема стойност null.
            </li>
            <li>
                accuracy - точност на местоположението. Запазена е стойността в метри. Всички имплементации са длъжни да поддържат този атрибут. Стойността му трябва да бъде неотрицателно реално число.
            </li>
            <li>
                altitudeAccuracy - точност на надморската височина. Запазена е стойността в метри. Ако имплементацията не поддържа надморска височина, то стойността е null. В противен случай стойността е неотрицателно реално число.
            </li>
            <li>
                heading - посока на движение. В случай че устройството се движи, то този атрибут показва посоката на движение. Стойностите които приема са от 0 до 360 градуса, като 0 отговаря на движение на север. Ако имплементацията не може да даде тази информация, то стойността на атрибута е null. Ако устройството е стационарно (тоест не се движи), атрибута има стойност NaN.
            </li>
            <li>
                speed - скорост на движение. Атрибута показва каква скоростта, с която се движи устройството. Стойността е в метри в секунда и е неотрицателно цяло число. Ако имплементацията не може да намери тази информация, то стойността на атрибута е null.
            </li>
        </ul>

        <h3> PositionError </h3>
        <pre class="prettyprint"><code>[NoInterfaceObject]
interface PositionError {
    const unsigned short PERMISSION_DENIED = 1;
    const unsigned short POSITION_UNAVAILABLE = 2;
    const unsigned short TIMEOUT = 3;
    readonly attribute unsigned short code;
    readonly attribute DOMString message;
};</code></pre>
        <p>Интерфейса PositionError съдържа информация за грешки, получени при търсенето на местоположението. Обект от този тип се връща от PositionErrorCallback. Има следните атрибути:</p>
        <ul>
            <li>
                code - атрибута съдържа кода на грешката. Видовете грешки са следните.
                <ul>
                    <li>
                        PERMISSION_DENIED - връща се когато документа не е авторизиран от потребителя да използва геолокация.
                    </li>
                    <li>
                        POSITION_UNAVAILABLE - връща се когато не може да бъде намерено местоположението. Това може да се случи например, когато някоя от системите за намиране на локация използвани от браузъра върне грешка, която чупи целия процес.
                    </li>
                    <li>
                        TIMEOUT - връща се когато таймера достине до стойността зададена в timeout.
                    </li>
                </ul>
            </li>
            <li>
                message - връща съобщение за детайлите на грешката, която е била срещната. Използва се за дебъгване и разработчите на браузъри не го използват директно в интерфейса на тяхното приложение.
            </li>
        </ul>

        <h2 id="example1">Пример</h2>
        <p>След като разгледахме в детайли как работят самите функции на HTML5 Geolocation API, ще разгледаме съвсем прост скрипт за да илюстрираме как се използва самото API в разработката на уеб приложения.</p>


<pre class="prettyprint"><code>&#60;button onclick&#61;&#34;getLocation&#40;&#41;&#34;&#62;Try It&#60;&#47;button&#62;
&#60;p id&#61;&#34;example&#34;&#62;&#60;&#47;p&#62;

&#60;script&#62;
var x &#61; document&#46;getElementById&#40;&#34;example&#34;&#41;&#59;
var options &#61; &#123; enableHighAccuracy&#58; true&#44;
                timeout&#58; &#53;&#48;&#48;&#48;&#44;
                maximumAge&#58; &#48;&#125;&#59;

function getLocation&#40;&#41; &#123;    
    if &#40;navigator&#46;geolocation&#41; &#123;    
        navigator&#46;geolocation&#46;getCurrentPosition&#40;showPosition&#44;
                                                 showError&#44; 
                                                 options&#41;&#59;
    &#125; 
    else &#123;
        x&#46;innerHTML &#61; &#34;This browser doesn&#39;t support the HTML&#53; Geolocation API&#46; Please switch to a newer version&#46;&#34;&#59;
    &#125;
&#125;

function showPosition&#40;position&#41; &#123;
    x&#46;innerHTML &#61; &#34;Latitude&#58; &#34; &#43; position&#46;coords&#46;latitude &#43;
                  &#34;&#60;br&#62;Longitude&#58; &#34; &#43; position&#46;coords&#46;longitude &#43;
                  &#34;&#60;br&#62;Altutude&#58; &#34; &#43; position&#46;coords&#46;altitude &#43;
                  &#34;&#60;br&#62;Accuracy&#58; &#34; &#43; position&#46;coords&#46;accuracy &#43;
                  &#34;&#60;br&#62;Altitude accuracy&#58; &#34; &#43; position&#46;coords&#46;altitudeAccuracy &#43; 
                  &#34;&#60;br&#62;Heading&#58; &#34; &#43; position&#46;coords&#46;heading &#43;
                  &#34;&#60;br&#62;Speed&#58; &#34; &#43; position&#46;coords&#46;speed&#59;
&#125;

function showError&#40;error&#41; &#123;    
    switch&#40;error&#46;code&#41; &#123;
        case error&#46;PERMISSION&#95;DENIED&#58;  
            x&#46;innerHTML &#61; &#34;User denied the request for Geolocation&#46;&#34;
            break&#59;  
        case error&#46;POSITION&#95;UNAVAILABLE&#58;
            x&#46;innerHTML &#61; &#34;Location information is unavailable&#46;&#34;
            break&#59;
        case error&#46;TIMEOUT&#58;      
            x&#46;innerHTML &#61; &#34;The request to get user location timed out&#46;&#34;
            break&#59;
    &#125;
&#125;
&#60;&#47;script&#62;</code></pre>

        <p>Нека разгледаме горния код в детайли.</p>
        <pre class="prettyprint"><code>&#60;button onclick&#61;&#34;getLocation&#40;&#41;&#34;&#62;Try It&#60;&#47;button&#62;
&#60;p id&#61;&#34;example&#34;&#62;&#60;&#47;p&#62;</code></pre>

        <p>Този код извиква функцията getLocation на нашия скрип, която се занимава с намирането и извеждането на географското положение.</p>

        <pre class="prettyprint"><code>function getLocation&#40;&#41; &#123;
    if &#40;navigator&#46;geolocation&#41; &#123;
        navigator&#46;geolocation&#46;getCurrentPosition&#40;showPosition&#44; showError&#44; options&#41;&#59;
    &#125; 
    else &#123;     
        x&#46;innerHTML &#61; &#34;This browser doesn&#39;t support the HTML&#53; Geolocation API&#46; Please switch to a newer version&#46;&#34;&#59;
    &#125;
&#125;</code></pre>

    <p>Това ни е фукцията, която извиква функцията getCurrentPosition от HTML5 Geolocation API. Първо чрез navigator.geolocation проверяваме дали браузъра на потребителя поддържа API-то за геолокация. В случай това е вярно му подаваме три параметъра - showPosition, showError и options. </p>

    <pre class="prettyprint"><code>function showPosition&#40;position&#41; 
&#123;
    x&#46;innerHTML &#61; &#34;Latitude&#58; &#34; &#43; position&#46;coords&#46;latitude &#43; 
                  &#34;&#60;br&#62;Longitude&#58; &#34; &#43; position&#46;coords&#46;longitude &#43;    
                  &#34;&#60;br&#62;Altutude&#58; &#34; &#43; position&#46;coords&#46;altitude &#43; 
                  &#34;&#60;br&#62;Accuracy&#58; &#34; &#43; position&#46;coords&#46;accuracy &#43;    
                  &#34;&#60;br&#62;Altitude accuracy&#58; &#34; &#43; position&#46;coords&#46;altitudeAccuracy &#43; 
                  &#34;&#60;br&#62;Heading&#58; &#34; &#43; position&#46;coords&#46;heading &#43; 
                  &#34;&#60;br&#62;Speed&#58; &#34; &#43; position&#46;coords&#46;speed&#59;  
&#125;</code></pre>

    <p>Функцията showPosition играе ролята на PositionCallback successCallback от API-то. Когато браузъра намери местоположението на потребителя извиква successCallback с параметъра positon, който е обекта съдържащ информацията за местоположението. Както разгледахме по-горе интерфейса Position съдържа атрибут с име coords, който съдържа всичката информация за местоположението. За да изведем информацията просто достъпваме атрибутите на coords както е показано в горния код.</p>

    <pre class="prettyprint"><code>function showError&#40;error&#41; &#123;  
    switch&#40;error&#46;code&#41; &#123;
        case error&#46;PERMISSION&#95;DENIED&#58;     
            x&#46;innerHTML &#61; &#34;Потребителят е забранил достъпа до геолокацията.&#46;&#34;
            break&#59;
        case error&#46;POSITION&#95;UNAVAILABLE&#58;
            x&#46;innerHTML &#61; &#34;Грешка при определянето на геолокацията.&#46;&#34;      
            break&#59;
        case error&#46;TIMEOUT&#58;
            x&#46;innerHTML &#61; &#34;Грешка. Времето за намиране на геолокацията е изтекло.&#46;&#34; 
            break&#59;
    &#125;
&#125;</code></pre>

        <p>Функцията showError играе ролята на errorCallback от API-то. Извиква се при грешка при намирането на геолокацията. Получава като параметър обект от тип PositionError. Проверявайки стойността на атрибута му code извеждаме подходящо съобщение за грешката, която е настъпила при търсенето на местоположението на потребителя.</p>


        <pre class="prettyprint"><code>var options &#61; &#123;
    enableHighAccuracy&#58; true&#44;
    timeout&#58; &#53;&#48;&#48;&#48;&#44;
    maximumAge&#58; &#48;
&#125;&#59;</code></pre>

        <p>Променливата options играе ролята на PositionOptions от API-то. При създането му сме дефинирали стойности за трите му атрибута, които се използват за настройване на търсенето на геолокацията при извикване на функцията showPosition.</p>

        <p>Разгледания по-горе код търси геолокацията на потребителя при натискане на бутона. При успешно намиране на такава извежда получения резултат, а при грешка извежда подходящо съобщение. Ето как изглежда горния скрип сложен в уебстраниця.</p>
        <div class="center-container">
        <div id="geolocation">
            <button onclick="getLocation()">Геолокация</button>
        
        <p id="example"></p>

        <script>
        var x = document.getElementById("example");

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition, showError);
            } else { 
                x.innerHTML = "Браузърът не използва HTML5 Geolocation API. Моля инсталирайте по-нова версия.";
            }
        }

        function showPosition(position) {
            x.innerHTML = "Географска ширина: " + position.coords.latitude + 
            "<br>Географска дължина: " + position.coords.longitude + 
            "<br>Надморска височина: " + position.coords.altitude + 
            "<br>Точност: " + position.coords.accuracy + 
            "<br>Точност на надморската височина: " + position.coords.altitudeAccuracy + 
            "<br>Посока на движение: " + position.coords.heading + 
            "<br>Скорост: " + position.coords.speed;  
        }

        function showError(error) {
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    x.innerHTML = "Потребителят е забранил достъпа до геолокацията."
                    break;
                case error.POSITION_UNAVAILABLE:
                    x.innerHTML = "Грешка при определянето на геолокацията."
                    break;
                case error.TIMEOUT:
                    x.innerHTML = "Грешка. Времето за намиране на геолокацията е изтекло."
                    break;
            }
        }
        </script>
        </div></div>

        <h2 id="end">Заключение</h2>
        <p>В крайна сметка добавеното API за геолокация в HTML5 е много полезно за създаването на уебприложения. Чрез стандартизацията на интерфейса за геолокация се ползволява на разработчиците да използват директно интерфейса, без да се нуждаят от допълнителен софтуер, който да работи само за определени браузъри. Геолокацията дава възможност за създаването на голям набор от уебприложение. Пример за такова приложение е например Google Maps, което дава възможност за навигация на базата на текущата геолокация. Множество други приложения използват геолокацията на потребителя, за да ву предложат различна информация за места и събития на близко разстояние от неговото местоположение. Въпреки страховете на някои хора за това, каква информация събират компаниите за тях, самото API осигорява някаква защита на данните.</p>

        <h2 id="resourses">Използвани източници</h2>
        <ol>
        <li><a href="https://en.wikipedia.org/wiki/HTML5">HTML 5 - Wikipedia, the free encyclopedia</a></li>
        <li><a href="https://en.wikipedia.org/wiki/WHATWG">WHATWG - Wikipedia, the free encyclopedia</a></li>
        <li><a href="https://en.wikipedia.org/wiki/W3C_Geolocation_API">W3C Geolocation API- Wikipedia, the free encyclopedia</a></li>
        <li><a href="https://en.wikipedia.org/wiki/Gears_%28software%29">Gears - Wikipedia, the free encyclopedia</a></li>
        <li><a href="http://www.w3.org/TR/geolocation-API/">Geolocation API Specification</a></li>
        <li><a href="http://help.opera.com/geolocation/en/">Geolocation with the Opera web browser</a></li>
        <li><a href="https://support.google.com/chrome/answer/142065?hl=en">Share your location on Chrome - Chrome Help</a></li>
        <li><a href="https://www.mozilla.org/en-GB/firefox/geolocation/">Mozilla Firefox Web Browser — Geolocation in Firefox — Mozilla</a></li>
        <li><a href="https://blogs.msdn.microsoft.com/ie/2011/02/17/w3c-geolocation-api-in-ie9/">W3C Geolocation API in IE9 | IEBlog</a></li>
        <li><a href="http://www.zdnet.com/article/how-google-and-everyone-else-gets-wi-fi-location-data/">How Google--and everyone else--gets Wi-Fi location data | ZDNet</a></li>
        <li><a href="http://www.andygup.net/html5-geolocation-api-%E2%80%93-how-accurate-is-it-really/">HTML5 Geolocation API – how accurate is it, really? &raquo; The Page Not Found Blog</a></li>
        <li><a href="http://techcrunch.com/2010/07/29/apple-location/">In April, Apple Ditched Google And Skyhook In Favor Of Its Own Location Databases  |  TechCrunch</a></li>
        <li><a href="http://www.w3schools.com/html/html5_geolocation.asp">HTML5 Geolocation | W3Schools</a></li>
        <li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Geolocation/getCurrentPosition">Geolocation.getCurrentPosition() - Web APIs | MDN</a></li>
    </ol>
    </div>
    </body>
</html>